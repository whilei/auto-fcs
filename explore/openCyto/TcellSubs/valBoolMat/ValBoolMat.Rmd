---
title: "ValBoolMat"
author: "JL"
date: "12/18/2018"
output: html_document
---

```{r setup, include=FALSE}

inDir ="/Volumes/Beta/data/flow/kmeansValidate/results_r26_TcellSubs_Kmeans_wsp_v8/"
outDir="/Volumes/Beta/data/flow/kmeansValidateResults/results_r26_TcellSubs_Kmeans_wsp_v8/"
dir.create(outDir)
summaryFile=paste0(outDir,"summmary.counts.results_r26_TcellSubs_Kmeans_wsp_v8.txt")
corSummaryFile=paste0(outDir,"summmary.cor.results_r26_TcellSubs_Kmeans_wsp_v8.txt")
cvSummaryFile=paste0(outDir,"summmary.cv.results_r26_TcellSubs_Kmeans_wsp_v8.txt")


dat=read.delim("/Volumes/Beta2/flow/valTSubs/out_man_r26.indiv.xln",sep = "\t",stringsAsFactors = FALSE,row.names = NULL)

dat$COUNT=dat$TP+dat$FP

summaries = read.delim(summaryFile,
                       stringsAsFactors = FALSE,
                       header = TRUE)
summaries$SANITIZE_NAME = gsub(" ","_",summaries$SAMPLE)
manuals=read.delim("/Volumes/Beta/data/flow/kmeansValidateResults/results_r26_TcellSubs_Kmeans_wsp_v8/r26_v3_Manual_Samples.txt",
                       stringsAsFactors = FALSE,
                       header = FALSE)

summaries$MANUAL_ANNOTATION= summaries$SANITIZE_NAME %in% manuals$V1
  

excludes = unique(summaries[which(summaries$NUM_POPS_ASSIGNED!=4),]$SAMPLE)
summaries=summaries[which(summaries$NUM_POPS_ASSIGNED==4),]
# 
# write.table(
#   excludes,
#   file = paste0(outDir,"excludes.txt"),
#   sep = "\t",
#   quote = FALSE,
#   row.names = FALSE
# )


# l = summaries[which(summaries$POPULATION=="CYTO_effector"&&summaries$COUNT<1000),]
# summaries[which(summaries$SAMPLE=="2016-11-17_PANEL 1_ZF_Group one_F1652905_004.fcs"),]

summaries$OPTIMAL_K = as.factor(summaries$OPTIMAL_K)
summaries$POPULATION = as.factor(summaries$POPULATION)
summaries$PARENT_FREQ = (summaries$COUNT) / summaries$PARENT_COUNT
summaries$PARENT_PERCENT = (summaries$COUNT * 100) / summaries$PARENT_COUNT

summaries = summaries[which(!is.na(summaries$PARENT_FREQ)), ]

summaries$POPULATION=gsub("CYTO_effector_CD28M_CD27M","pE cytotoxic Tcells (CD27-  CD28-)",summaries$POPULATION)
summaries$POPULATION=gsub("CYTO_effector_CD28P_CD27P","pE1 cytotoxic Tcells (CD27+  CD28+)",summaries$POPULATION)
summaries$POPULATION=gsub("CYTO_effector_CD28M_CD27P","pE2 cytotoxic Tcells (CD27+ , CD28-)",summaries$POPULATION)

summaries$POPULATION=gsub("CYTO_effector memory_CD28P_CD27P","EM1 cytotoxic Tcells (CD27+  CD28+)",summaries$POPULATION)
summaries$POPULATION=gsub("CYTO_effector memory_CD28M_CD27P","EM2 cytotoxic Tcells (CD27+  CD28-)",summaries$POPULATION)
summaries$POPULATION=gsub("CYTO_effector memory_CD28M_CD27M","EM3 cytotoxic Tcells (CD27-  CD28-)",summaries$POPULATION)
summaries$POPULATION=gsub("CYTO_effector memory_CD28P_CD27M","EM4 cytotoxic Tcells (CD27-  CD28+)",summaries$POPULATION)

summaries$KEY = paste0(summaries$LAB_ID, "_", summaries$POPULATION)
summaries$KEYFCS = paste0(summaries$SAMPLE, "_", summaries$POPULATION)

trim = !grepl("CD28",summaries$POPULATION)
summariesTrim=summaries[trim,]
summariesTrimC0=summariesTrim[which(summariesTrim$COUNT==0),]
counts =as.data.frame(table(summariesTrimC0$SAMPLE,summariesTrimC0$COUNT))
sub= counts[which(counts$Var2==0),]
keep =!(summaries$SAMPLE %in% sub$Var1)
rid =(summaries$SAMPLE %in% sub$Var1)


excludes = unique(c(excludes, summaries[rid, ]$SAMPLE))
excludesDF =data.frame(
    EXCLUDE_SAMPLE = excludes,
    EXCLUDE_SAMPLE_SANITIZE = gsub(" ", "_", excludes)
  )
# excludesDF =m
map=read.delim("/Volumes/Beta/data/flow/results_r25_25full_SS_SubCD8_SCD14_Manuals/FULL/all.totalCellCounts.metrics.format.txt",
                         stringsAsFactors = FALSE,
                         header = TRUE)
map =map[which(map$PANEL=="panel1"),]
excludesDF =merge(excludesDF,map,by.x ="EXCLUDE_SAMPLE",by.y = "FILE",all.x=TRUE )
# 
# write.table(
#   excludesDF,
#   file = paste0(summaryFile, ".exclude.txt"),
#   sep = "\t",
#   quote = FALSE,
#   row.names = FALSE
# )

hist(excludesDF$TOTAL_COUNTS)
# write.table(
#   data.frame(
#     EXCLUDE_SAMPLE = excludes  ),
#   file = paste0(summaryFile, ".excludeTransfer.txt"),
#   sep = "\t",
#   quote = FALSE,
#   row.names = FALSE
# )


summaries=summaries[keep,]

dat$KEY=paste0(,dat)
summaries=merge(summaries,dat)


```

